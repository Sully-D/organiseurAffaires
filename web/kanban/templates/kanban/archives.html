{% extends 'kanban/base.html' %}

{% block content %}
<div class="board-header">
    <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem; color: #94a3b8;">
        <i class="fa-solid fa-box-archive"></i> Archives
    </h2>
</div>

<div class="board-container" style="display: block; overflow-y: auto; padding: 1rem;">
    {% if activities %}
    <div class="grid-view"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
        {% for activity in activities %}
        <div class="activity-card" data-id="{{ activity.id }}" data-name="{{ activity.name }}"
            data-date="{{ activity.date|date:'Y-m-d' }}" style="cursor: pointer;">
            <div class="card-header">
                <span class="date"><i class="fa-regular fa-calendar"></i> {{ activity.date|date:"d/m/Y" }}</span>
                {% if activity.tags.all %}
                <div class="tags">
                    {% for tag in activity.tags.all %}
                    <span class="tag" style="background-color: {{ tag.color }};">{{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <h3 class="card-title">{{ activity.name }}</h3>
            <div class="card-description">
                {{ activity.description|truncatechars:100 }}
            </div>
            <div class="card-actions" style="margin-top: 1rem; display: flex; justify-content: flex-end;">
                {% if user.is_superuser %}
                <button class="btn-icon" onclick="event.stopPropagation(); unarchiveActivity({{ activity.id }})"
                    title="Restaurer" style="color: #4ade80;">
                    <i class="fa-solid fa-rotate-left"></i> Restaurer
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; color: #64748b; margin-top: 3rem;">
        <i class="fa-solid fa-box-open" style="font-size: 3rem; margin-bottom: 1rem;"></i>
        <p>Aucune activité archivée.</p>
    </div>
    {% endif %}
</div>

<!-- Modal Container -->
<div id="activityModal" class="modal-overlay">
    <div class="modal-content" id="modalContent">
        <!-- Content loaded via AJAX -->
    </div>
</div>

<script>
    // Modal Logic
    const modal = document.getElementById('activityModal');

    function openModal() {
        modal.classList.add('active');
    }

    function closeModal() {
        modal.classList.remove('active');
        // Optionally refresh page on close if data changed, or rely on specific updates
        location.reload();
    }

    // Close on outside click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Card Click Handler
    document.querySelectorAll('.activity-card').forEach(card => {
        card.addEventListener('click', function (e) {
            // Prevent if clicking buttons
            if (e.target.closest('button')) return;

            const activityId = this.getAttribute('data-id');
            openModal();

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Chargement...</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <p style="color: #94a3b8; text-align: center; padding: 2rem;">
                        <i class="fa-solid fa-spinner fa-spin"></i> Récupération des données...
                    </p>
                </div>
            `;

            fetch(`/activity/${activityId}/`)
                .then(response => response.text())
                .then(html => {
                    modalContent.innerHTML = html;
                    // Execute scripts
                    const scripts = modalContent.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.body.appendChild(newScript);
                        document.body.removeChild(newScript);
                    });
                })
                .catch(err => {
                    modalContent.innerHTML = `
                        <div class="modal-header">
                            <h2>Erreur</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <p style="color: #ef4444;">Impossible de charger les détails.</p>
                        </div>
                    `;
                });
        });
    });

    function unarchiveActivity(id) {
        if (!confirm('Restaurer cette activité vers "En attente" ?')) return;

        const csrftoken = getCookie('csrftoken');
        fetch(`/api/activity/${id}/unarchive/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        }).then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Erreur: ' + data.message);
                }
            });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}